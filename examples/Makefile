target=	simduino
firm_src = ${wildcard atmega*.c}
firmware = ${firm_src:.c=.hex}
SHELL := /bin/bash
IPATH = . ../simavr/sim ../simavr/include ../parts
VPATH = . ../parts

all: obj ${firmware} ${target}


CFLAGS		+= -O2 -Wall -Wextra -Wno-unused-parameter \
			-Wno-unused-result -Wno-missing-field-initializers \
			-Wno-sign-compare -g -fPIC -DHAVE_LIBELF=1 
CPPFLAGS	+= --std=gnu99 -Wall
CPPFLAGS	+= ${patsubst %,-I%,${subst :, ,${IPATH}}}
CC 		?= clang
MKDIR		?= mkdir -p
OBJ 		:= obj-${shell $(CC) -dumpmachine}
LDFLAGS		+= -L../simavr/${OBJ} -lsimavr -lm -lelf -lpthread -lutil
LFLAGS		+= -Wl,-rpath,../simavr/${OBJ}


%.hex: %.axf
	avr-objcopy -j .text -j .data -j .eeprom -O ihex ${<} ${@}

%.s: %.axf
	avr-objdump -j .text -j .data -j .bss -d  ${<} > ${@}

%.axf: %.c
	avr-gcc -Wall -gdwarf-2 -Os -std=gnu99 \
			-mmcu=${shell v=${<} && echo $${v/_*}} \
			-DF_CPU=8000000 \
			-fno-inline-small-functions \
			-ffunction-sections -fdata-sections \
			-Wl,--relax,--gc-sections \
			-Wl,--undefined=_mmcu,--section-start=.mmcu=0x910000 \
			-I../simavr/sim/avr  \
			${^} -o ${@}
	avr-size ${@}|sed '1d'


${OBJ}/%.elf:
	$(CC) -MMD ${CFLAGS}  ${LFLAGS} -o $@ ${filter %.o,$^} $(LDFLAGS)

${OBJ}/%.o: %.c | ${OBJ}
	$(CC) $(CPPFLAGS) $(CFLAGS) -MMD $< -c -o $@

obj: ${OBJ}

${OBJ}:
	mkdir -p ${OBJ}

clean:
		rm -rf *.a *.axf ${target} *.vcd *.hex ${OBJ}

# include the dependency files generated by gcc, if any
-include ${wildcard ${OBJ}/*.d}


${OBJ}/${target}.elf : ${OBJ}/uart_pty.o ${OBJ}/${target}.o
 
${target}: ${OBJ}/${target}.elf
	@echo $@ done


